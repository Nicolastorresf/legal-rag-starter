# PoC ‚Äî Asesor legal con RAG sobre Excel de sentencias (ChromaDB)

> **Objetivo.** Responder en lenguaje coloquial preguntas sobre demandas relacionadas con **redes sociales** a partir de un Excel con sentencias, usando **b√∫squeda sem√°ntica** con embeddings y **ChromaDB**.

---

## üßæ Entregables

- **C√≥digo funcional** (scripts en `src/`).
- **Informe** con los t√≠tulos solicitados (incluido m√°s abajo).
- **Gu√≠a de ejecuci√≥n** paso a paso.

---

## üöÄ Quickstart (3 comandos)

```bash
pip install -r requirements.txt
python -m src.ingest_index
python -m src.qa --q "acoso escolar" --debug

--- 

# crear y activar entorno
python -m venv .venv
# Windows
.venv\Scripts\activate
# macOS/Linux
source .venv/bin/activate

---

##  üóÇÔ∏è Estructura del repositorio
.
‚îú‚îÄ .chroma/                     # √≠ndice persistente (se genera al indexar)
‚îú‚îÄ Caso/
‚îÇ  ‚îî‚îÄ Caso de consultoria 2.pdf
‚îú‚îÄ Datos/
‚îÇ  ‚îî‚îÄ sentencias_pasadas.xlsx
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ config.yaml               # configuraci√≥n (ruta, modelo, sin√≥nimos, umbrales)
‚îÇ  ‚îú‚îÄ ingest_index.py           # indexa el Excel en ChromaDB
‚îÇ  ‚îú‚îÄ debug_chroma.py           # verifica colecci√≥n/contador/peek
‚îÇ  ‚îú‚îÄ qa.py                     # consulta sem√°ntica + armado de respuesta
‚îÇ  ‚îî‚îÄ utils.py                  # helpers: load_config, limpieza, sin√≥nimos
‚îú‚îÄ README.md
‚îî‚îÄ requirements.txt

---

# 1) Instalar dependencias
pip install -r requirements.txt

# 2) Indexar el Excel en ChromaDB
python -m src.ingest_index

# 3) Verificar la colecci√≥n
python -m src.debug_chroma

# 4) Consultas (QA)
python -m src.qa --q "acoso escolar" --debug
python -m src.qa --q "PIAR" --debug
python -m src.qa --q "redes sociales" --debug

---

## Tip: si recuperas pocos resultados, sube retrieval.distance_max a 0.40 y/o retrieval.k a 10‚Äì12.

üß† C√≥mo funciona 

Indexaci√≥n: se concatenan los campos listados en text_fields y se guardan como documento + metadatos (m_<campo>).

Embeddings: paraphrase-multilingual-mpnet-base-v2 (robusto en espa√±ol).

Vector DB: ChromaDB persistente (HNSW, m√©trica cosine).

Consulta: expansi√≥n de sin√≥nimos, top-k y filtrado por umbral distance_max.

Respuesta: plantilla en lenguaje simple con bullets (usa metadatos como m_Tema - subtema y m_s√≠ntesis) + lista de Fuentes con ID y distancia.

---

## Informe 
1) Explicaci√≥n del caso

PoC para responder en lenguaje coloquial preguntas sobre demandas y sentencias asociadas a redes sociales a partir de un Excel. La salida incluye evidencia trazable (IDs y distancias) para validaci√≥n r√°pida.

2) Supuestos

El Excel incluye un identificador (id_col) y campos de texto relevantes (Tema/Hechos/S√≠ntesis/Sentencia).

La respuesta se construye a partir de los documentos recuperados (RAG ‚Äúligero‚Äù, sin LLM remoto).

Idioma principal: espa√±ol con variaciones; se usan sin√≥nimos.

3) Formas para resolver el caso y opci√≥n tomada

Alternativas: (1) TF-IDF/regex; (2) Embeddings + ChromaDB ‚úÖ; (3) RAG con re-ranking + LLM; (4) Clasificaci√≥n/finetuning.

Elegida: (2) por equilibrio entre precisi√≥n, reproducibilidad y evidencia trazable.

4) Resultados del an√°lisis de los datos y los modelos

Acoso escolar ‚Äî sentencia y detalle
(comando: python -m src.qa --q "acoso escolar" --debug)

=== RESPUESTA ===
Sobre ‚Äúacoso escolar‚Äù, encontr√© 2 referencias claras en el archivo.

- Caso T-168/22: ACCION DE TUTELA CONTRA INSTITUCION EDUCATIVA-Procedencia ACOSO ESCOLAR O BULLYING-Manejo por parte de las instituciones ‚Äî La accionante, actuando en representaci√≥n de una hija menor de edad, alega que la instituci√≥n educativa accionada vulner√≥ derechos fundament‚Ä¶
- Caso T-252/23: ACCION DE TUTELA PARA RECLAMAR INDEMNIZACION DE PERJUICIOS-Procedencia excepcional ACOSO ESCOLAR O BULLYING-Manejo por p ‚Äî La accionante, actuando en representaci√≥n de su hijo menor de edad, cuestion√≥ a la accionada y formul√≥ pretensiones que se dividieron en dos‚Ä¶

Fuentes:
‚Ä¢ ID T-168/22: dist=0.2691
‚Ä¢ ID T-252/23: dist=0.3387


PIAR ‚Äî casos y sentencias
(comando: python -m src.qa --q "PIAR" --debug)

=== RESPUESTA ===
Sobre ‚ÄúPIAR‚Äù, encontr√© 1 referencias claras en el archivo.

- Caso T-085/23: ACCESIBILIDAD Y ADAPTABILIDAD COMO COMPONENTES ESENCIALES DEL DERECHO A LA EDUCACION CARENCIA ACTUAL DE OBJETO POR HECHO ‚Äî La accionante act√∫a en representaci√≥n de un hijo menor de edad que fue diagnosticado con el s√≠ndrome Landau Kleffner, el cual le genera difi‚Ä¶

Fuentes:
‚Ä¢ ID T-085/23: dist=0.2873


Redes sociales ‚Äî ejemplos y sentencias
(comando: python -m src.qa --q "redes sociales" --debug)

=== RESPUESTA ===
Sobre ‚Äúredes sociales‚Äù, encontr√© 40 referencias posibles en el archivo. (evidencia d√©bil).

- Caso T-031/20: ACCION DE TUTELA CONTRA PARTICULARES-No se requiere solicitud previa de rectificaci√≥n de publicaci√≥n en Facebook DERECHO ‚Äî La problem√°tica planteada en este asunto tuvo origen en un conflicto de √≠ndole personal suscitado entre dos servidores p√∫blicos que compart√≠‚Ä¶
- Caso T-610/19: CARENCIA ACTUAL DE OBJETO POR HECHO SUPERADO-El video subido a la red social fue eliminado de la plataforma DERECHO A LA ‚Äî La accionante, actuando en nombre de su hija menor de edad, aduce que varios medios de comunicaci√≥n vulneraron los derechos a la honra, al b‚Ä¶
- Caso T-155/19: DERECHO A LA INTIMIDAD-Alcance y contenido DERECHOS A LA INTIMIDAD, BUEN NOMBRE Y HONRA FRENTE A LIBERTAD DE EXPRESION Y ‚Äî En el presente caso, se atribuye la vulneraci√≥n de los derechos fundamentales a una publicaci√≥n realizada por la accionada en la red social ‚Ä¶

Fuentes:
‚Ä¢ ID T-031/20: dist=0.4207
‚Ä¢ ID T-610/19: dist=0.4319
‚Ä¢ ID T-155/19: dist=0.4694


Nota: en ‚Äúredes sociales‚Äù las distancias son superiores al umbral por defecto (0.35), por eso el motor las marca como evidencia d√©bil. Para reforzar, puedes subir retrieval.k y/o aumentar distance_max a 0.40.

5) Futuros ajustes o mejoras

Re-ranking con cross-encoder para ordenar mejor los hits.

LLM generativo para redacciones m√°s ricas y verificaci√≥n de consistencia.

Guardrails: si no hay evidencia < umbral, devolver ‚Äúno se encontr√≥ evidencia suficiente‚Äù.

UI (Gradio/Streamlit) y API REST (FastAPI).

Despliegue en Azure/AWS (contenedor + volumen para .chroma).

Mejoras de datos: normalizaci√≥n de encabezados/acentos y enriquecimiento con etiquetas.

6) Apreciaciones y comentarios 

La PoC demuestra que, sin LLM, ya se logra una b√∫squeda √∫til y explicable (IDs + distancias), con bajo costo y f√°cil reproducci√≥n.
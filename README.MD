# PoC â€” Asesor legal con RAG sobre Excel de sentencias (ChromaDB)

> **Objetivo.** Responder en lenguaje coloquial preguntas sobre demandas relacionadas con **redes sociales** a partir de un Excel con sentencias, usando **bÃºsqueda semÃ¡ntica** con embeddings y **ChromaDB**.

---

## ğŸ§¾ Entregables

- **CÃ³digo funcional** (scripts en `src/`).
- **Informe** con los tÃ­tulos solicitados (incluido mÃ¡s abajo).
- **GuÃ­a de ejecuciÃ³n** paso a paso.

---

## ğŸš€ Quickstart (3 comandos)

```bash
pip install -r requirements.txt
python -m src.ingest_index
python -m src.qa --q "acoso escolar" --debug
```

<details>
<summary>Usar venv (opcional)</summary>

```bash
# crear y activar entorno
python -m venv .venv
# Windows
.venv\Scripts\activate
# macOS/Linux
source .venv/bin/activate
```
</details>

---

## ğŸ—‚ï¸ Estructura del repositorio

```
.
â”œâ”€ .chroma/                     # Ã­ndice persistente (se genera al indexar)
â”œâ”€ Caso/
â”‚  â””â”€ Caso de consultoria 2.pdf
â”œâ”€ Datos/
â”‚  â””â”€ sentencias_pasadas.xlsx
â”œâ”€ src/
â”‚  â”œâ”€ config.yaml               # configuraciÃ³n (ruta, modelo, sinÃ³nimos, umbrales)
â”‚  â”œâ”€ ingest_index.py           # indexa el Excel en ChromaDB
â”‚  â”œâ”€ debug_chroma.py           # verifica colecciÃ³n/contador/peek
â”‚  â”œâ”€ qa.py                     # consulta semÃ¡ntica + armado de respuesta
â”‚  â””â”€ utils.py                  # helpers: load_config, limpieza, sinÃ³nimos
â”œâ”€ README.md
â””â”€ requirements.txt
```

---

## âš™ï¸ ConfiguraciÃ³n 


```yaml
data_path: "Datos/sentencias_pasadas.xlsx"
id_col: "ID"                   # o "Radicado", etc.
text_fields:
  - "Tema - subtema"
  - "Hechos"
  - "sÃ­ntesis"                 # si es "sintesis" en tu archivo, cÃ¡mbialo
  - "Sentencia"

embedding_model: "sentence-transformers/paraphrase-multilingual-mpnet-base-v2"

chroma:
  persist_dir: ".chroma"
  collection: "sentencias_lex"
  metric: "cosine"

retrieval:
  k: 8
  min_hits: 1
  distance_max: 0.35          # menor = mÃ¡s estricto

synonyms:
  "acoso escolar": ["bullying", "matoneo", "hostigamiento escolar", "violencia escolar"]
  "piar": ["plan individual de ajustes razonables", "ajustes razonables", "inclusiÃ³n educativa", "discapacidad", "NEE"]
  "redes sociales": ["facebook", "instagram", "tiktok", "x", "twitter", "red social"]
```

---

## â–¶ï¸ CÃ³mo ejecutar

```bash
# 1) Instalar dependencias
pip install -r requirements.txt

# 2) Indexar el Excel en ChromaDB
python -m src.ingest_index

# 3) Verificar la colecciÃ³n
python -m src.debug_chroma

# 4) Consultas (QA)
python -m src.qa --q "acoso escolar" --debug
python -m src.qa --q "PIAR" --debug
python -m src.qa --q "redes sociales" --debug
```

> Tip: si recuperas pocos resultados, sube `retrieval.distance_max` a `0.40` y/o `retrieval.k` a `10â€“12`.

---

## ğŸ§  CÃ³mo funciona (resumen tÃ©cnico)

- **IndexaciÃ³n**: se concatenan los campos listados en `text_fields` y se guardan como documento + metadatos (`m_<campo>`).
- **Embeddings**: `paraphrase-multilingual-mpnet-base-v2` (robusto en espaÃ±ol).
- **Vector DB**: ChromaDB persistente (HNSW, mÃ©trica `cosine`).
- **Consulta**: expansiÃ³n de sinÃ³nimos, top-k y filtrado por umbral `distance_max`.
- **Respuesta**: plantilla en lenguaje simple con bullets (usa metadatos como `m_Tema - subtema` y `m_sÃ­ntesis`) + lista de **Fuentes** con ID y distancia.

---

## ğŸ“Š Informe (con resultados reales pegados)

### 1) ExplicaciÃ³n del caso
PoC para responder en lenguaje coloquial preguntas sobre **demandas y sentencias asociadas a redes sociales** a partir de un **Excel**. La salida incluye **evidencia trazable** (IDs y distancias) para validaciÃ³n rÃ¡pida.

### 2) Supuestos
- El Excel incluye un identificador (`id_col`) y campos de texto relevantes (Tema/Hechos/SÃ­ntesis/Sentencia).
- La respuesta se construye a partir de los documentos recuperados (RAG â€œligeroâ€, sin LLM remoto).
- Idioma principal: espaÃ±ol con variaciones; se usan sinÃ³nimos.

### 3) Formas para resolver el caso y opciÃ³n tomada
- **Alternativas**: (1) TF-IDF/regex; (2) **Embeddings + ChromaDB** âœ…; (3) RAG con re-ranking + LLM; (4) ClasificaciÃ³n/finetuning.
- **Elegida**: (2) por equilibrio entre precisiÃ³n, reproducibilidad y evidencia trazable.

### 4) Resultados del anÃ¡lisis de los datos y los modelos

**Acoso escolar â€” sentencia y detalle**  
_(comando: `python -m src.qa --q "acoso escolar" --debug`)_

```text
=== RESPUESTA ===
Sobre â€œacoso escolarâ€, encontrÃ© 2 referencias claras en el archivo.

- Caso T-168/22: ACCION DE TUTELA CONTRA INSTITUCION EDUCATIVA-Procedencia ACOSO ESCOLAR O BULLYING-Manejo por parte de las instituciones â€” La accionante, actuando en representaciÃ³n de una hija menor de edad, alega que la instituciÃ³n educativa accionada vulnerÃ³ derechos fundamentâ€¦
- Caso T-252/23: ACCION DE TUTELA PARA RECLAMAR INDEMNIZACION DE PERJUICIOS-Procedencia excepcional ACOSO ESCOLAR O BULLYING-Manejo por p â€” La accionante, actuando en representaciÃ³n de su hijo menor de edad, cuestionÃ³ a la accionada y formulÃ³ pretensiones que se dividieron en dosâ€¦

Fuentes:
â€¢ ID T-168/22: dist=0.2691
â€¢ ID T-252/23: dist=0.3387
```

**PIAR â€” casos y sentencias**  
_(comando: `python -m src.qa --q "PIAR" --debug`)_

```text
=== RESPUESTA ===
Sobre â€œPIARâ€, encontrÃ© 1 referencias claras en el archivo.

- Caso T-085/23: ACCESIBILIDAD Y ADAPTABILIDAD COMO COMPONENTES ESENCIALES DEL DERECHO A LA EDUCACION CARENCIA ACTUAL DE OBJETO POR HECHO â€” La accionante actÃºa en representaciÃ³n de un hijo menor de edad que fue diagnosticado con el sÃ­ndrome Landau Kleffner, el cual le genera difiâ€¦

Fuentes:
â€¢ ID T-085/23: dist=0.2873
```

**Redes sociales â€” ejemplos y sentencias**  
_(comando: `python -m src.qa --q "redes sociales" --debug`)_

```text
=== RESPUESTA ===
Sobre â€œredes socialesâ€, encontrÃ© 40 referencias posibles en el archivo. (evidencia dÃ©bil).

- Caso T-031/20: ACCION DE TUTELA CONTRA PARTICULARES-No se requiere solicitud previa de rectificaciÃ³n de publicaciÃ³n en Facebook DERECHO â€” La problemÃ¡tica planteada en este asunto tuvo origen en un conflicto de Ã­ndole personal suscitado entre dos servidores pÃºblicos que compartÃ­â€¦
- Caso T-610/19: CARENCIA ACTUAL DE OBJETO POR HECHO SUPERADO-El video subido a la red social fue eliminado de la plataforma DERECHO A LA â€” La accionante, actuando en nombre de su hija menor de edad, aduce que varios medios de comunicaciÃ³n vulneraron los derechos a la honra, al bâ€¦
- Caso T-155/19: DERECHO A LA INTIMIDAD-Alcance y contenido DERECHOS A LA INTIMIDAD, BUEN NOMBRE Y HONRA FRENTE A LIBERTAD DE EXPRESION Y â€” En el presente caso, se atribuye la vulneraciÃ³n de los derechos fundamentales a una publicaciÃ³n realizada por la accionada en la red social â€¦

Fuentes:
â€¢ ID T-031/20: dist=0.4207
â€¢ ID T-610/19: dist=0.4319
â€¢ ID T-155/19: dist=0.4694
```

> **Nota:** en â€œredes socialesâ€ las distancias son superiores al umbral por defecto (`0.35`), por eso el motor las marca como **evidencia dÃ©bil**. Para reforzar, puedes subir `retrieval.k` y/o aumentar `distance_max` a `0.40`.

### 5) Futuros ajustes o mejoras
- **Re-ranking** con cross-encoder para ordenar mejor los hits.
- **LLM generativo** para redacciones mÃ¡s ricas y verificaciÃ³n de consistencia.
- **Guardrails**: si no hay evidencia < umbral, devolver â€œno se encontrÃ³ evidencia suficienteâ€.
- **UI** (Gradio/Streamlit) y **API REST** (FastAPI).
- **Despliegue** en Azure/AWS (contenedor + volumen para `.chroma`).
- **Mejoras de datos**: normalizaciÃ³n de encabezados/acentos y enriquecimiento con etiquetas.

### 6) Apreciaciones y comentarios (opcional)
La PoC demuestra que, **sin LLM**, ya se logra una bÃºsqueda Ãºtil y **explicable** (IDs + distancias), con bajo costo y fÃ¡cil reproducciÃ³n.

---

## ğŸ§° Troubleshooting

- **No encuentra â€œsÃ­ntesisâ€** â†’ usa exactamente el nombre real (p. ej., `sintesis`) en `text_fields`.
- **Pocos resultados** â†’ sube `retrieval.k` (10â€“12) y/o `retrieval.distance_max` (0.40).
- **IDs duplicados** â†’ el indexador aÃ±ade sufijos `__<row>` para evitar choques.
- **Cambiar modelo** â†’ ajusta `embedding_model` en `config.yaml` y re-indexa.

---

## ğŸ—ƒï¸ Comandos Ãºtiles

```bash
# Re-crear Ã­ndice desde cero
if [ -d ".chroma" ]; then rm -rf .chroma; fi
python -m src.ingest_index

# Verificar colecciÃ³n
python -m src.debug_chroma

# Consultas de ejemplo
python -m src.qa --q "acoso escolar" --debug
python -m src.qa --q "PIAR" --debug
python -m src.qa --q "redes sociales" --debug
```

---

## ğŸ“Œ Licencia
Uso interno para evaluaciÃ³n tÃ©cnica.
